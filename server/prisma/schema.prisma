generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int                  @id @default(autoincrement())
  uid           String               @unique @default(uuid())
  email         String?
  name          String?
  bio           String?
  photoURL      String?
  betaAccess    String?
  github        String?
  company       String?
  language      String?
  references    String?
  twitter       String?
  address       String?
  lat           Float?
  lng           Float?
  timezone      String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  talks         Talk[]               @relation("speakers_talks")
  proposals     Proposal[]           @relation("speakers_proposals")
  organizations OrganizationMember[]
  ratings       Rating[]
  surveys       Survey[]
  createdTalks  Talk[]
  createdEvents Event[]
  messages      Message[]
  invites       Invite[]

  @@map("users")
}

model Talk {
  id             Int        @id @default(autoincrement())
  uid            String     @unique @default(uuid())
  title          String
  abstract       String
  level          TalkLevel?
  language       String?
  references     String?
  creatorId      Int
  creator        User       @relation(fields: [creatorId], references: [id])
  archived       Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  speakers       User[]     @relation("speakers_talks")
  proposals      Proposal[]
  invitationUuid String?
  invitation     Invite?    @relation(fields: [invitationUuid], references: [uuid])

  @@map("talks")
}

enum TalkLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model BetaKey {
  uuid         String  @id @default(uuid())
  organization String?

  @@map("beta_keys")
}

model Event {
  id                       Int             @id @default(autoincrement())
  uid                      String          @unique @default(uuid())
  name                     String
  description              String
  type                     EventType       @default(CONFERENCE)
  visibility               EventVisibility @default(PRIVATE)
  organizationId           Int?
  organization             Organization?   @relation(fields: [organizationId], references: [id])
  address                  String?
  lat                      Float?
  lng                      Float?
  timezone                 String?
  contact                  String?
  website                  String?
  bannerUrl                String?
  conferenceStart          DateTime?
  conferenceEnd            DateTime?
  cfpStart                 DateTime?
  cfpEnd                   DateTime?
  formats                  EventFormat[]
  formatsRequired          Boolean         @default(false)
  categories               EventCategory[]
  categoriesRequired       Boolean         @default(false)
  maxProposals             Int?
  creatorId                Int
  creator                  User            @relation(fields: [creatorId], references: [id])
  archived                 Boolean         @default(false)
  deliberationEnabled      Boolean         @default(false)
  displayOrganizersRatings Boolean         @default(true)
  displayProposalsRatings  Boolean         @default(true)
  displayProposalsSpeakers Boolean         @default(true)
  surveyEnabled            Boolean         @default(false)
  surveyQuestions          Json?
  emailOrganizer           String?
  emailNotifications       Json?
  slackWebhookUrl          String?
  slackNotifications       Json?
  apiKey                   String?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  proposals                Proposal[]
  surveys                  Survey[]

  @@map("events")
}

model EventFormat {
  id          Int        @id @default(autoincrement())
  uid         String     @default(uuid())
  name        String
  description String?
  event       Event?     @relation(fields: [eventId], references: [id])
  eventId     Int?
  proposals   Proposal[] @relation("proposals_formats")

  @@map("event_formats")
}

model EventCategory {
  id          Int        @id @default(autoincrement())
  uid         String     @default(uuid())
  name        String
  description String?
  event       Event?     @relation(fields: [eventId], references: [id])
  eventId     Int?
  proposals   Proposal[] @relation("proposals_categories")

  @@map("event_categories")
}

enum EventType {
  MEETUP
  CONFERENCE
}

enum EventVisibility {
  PUBLIC
  PRIVATE
}

model Organization {
  id             Int                  @id @default(autoincrement())
  uid            String               @unique @default(uuid())
  name           String
  invitationUuid String?
  invitation     Invite?              @relation(fields: [invitationUuid], references: [uuid])
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  members        OrganizationMember[]
  events         Event[]

  @@map("organizations")
}

model OrganizationMember {
  member         User             @relation(fields: [memberId], references: [id])
  memberId       Int
  organization   Organization     @relation(fields: [organizationId], references: [id])
  organizationId Int
  role           OrganizationRole @default(REVIEWER)
  createdAt      DateTime         @default(now())

  @@id([memberId, organizationId])
  @@map("organizations_members")
}

enum OrganizationRole {
  OWNER
  MEMBER
  REVIEWER
}

model Proposal {
  id              Int             @id @default(autoincrement())
  uid             String          @unique @default(uuid())
  talkId          Int?
  talk            Talk?           @relation(fields: [talkId], references: [id])
  eventId         Int
  event           Event           @relation(fields: [eventId], references: [id])
  title           String
  abstract        String
  level           TalkLevel?
  language        String?
  references      String?
  comments        String?
  speakers        User[]          @relation("speakers_proposals")
  formats         EventFormat[]   @relation("proposals_formats")
  categories      EventCategory[] @relation("proposals_categories")
  ratings         Rating[]
  avgRateForSort  Float?
  status          ProposalStatus  @default(SUBMITTED)
  emailStatus     EmailStatus?
  speakerNotified Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  messages        Message[]

  @@unique([talkId, eventId])
  @@map("proposals")
}

enum ProposalStatus {
  SUBMITTED
  ACCEPTED
  REJECTED
  CONFIRMED
  DECLINED
}

enum EmailStatus {
  SENT
  DELIVERED
}

model Survey {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  eventId   Int
  event     Event    @relation(fields: [eventId], references: [id])
  answers   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId])
  @@map("surveys")
}

model Rating {
  id         Int           @id @default(autoincrement())
  uid        String        @unique @default(uuid())
  userId     Int
  user       User          @relation(fields: [userId], references: [id])
  proposalId Int
  proposal   Proposal      @relation(fields: [proposalId], references: [id])
  feeling    RatingFeeling @default(NEUTRAL)
  rating     Int?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@unique([userId, proposalId])
  @@map("ratings")
}

enum RatingFeeling {
  LOVE
  HATE
  NEUTRAL
  NO_OPINION
}

model Message {
  id         Int            @id @default(autoincrement())
  uid        String         @unique @default(uuid())
  userId     Int
  user       User           @relation(fields: [userId], references: [id])
  proposalId Int
  proposal   Proposal       @relation(fields: [proposalId], references: [id])
  message    String
  channel    MessageChannel
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@map("messages")
}

enum MessageChannel {
  ORGANIZER
  SPEAKER
}

model Invite {
  uuid         String         @id @default(uuid())
  type         InviteType
  entityId     Int
  userId       Int
  invitedBy    User           @relation(fields: [userId], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  organization Organization[]
  talks        Talk[]

  @@unique([type, entityId])
  @@map("invites")
}

enum InviteType {
  ORGANIZATION
  SPEAKER
}
